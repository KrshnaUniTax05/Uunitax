<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Login & Signup</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            font-family: 'Inter', sans-serif;
        }
        .card-shadow {
            box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Auth Container -->
    <div id="authContainer" class="w-full max-w-md card-shadow bg-white rounded-xl overflow-hidden">
        
        <!-- Header -->
        <div class="bg-blue-600 text-white text-center p-6 text-2xl font-bold">
            Welcome to Our Platform
        </div>
        
        <!-- Tabs -->
        <div class="flex border-b border-gray-200">
            <button id="login-tab" class="tab-button w-1/2 py-3 text-center text-lg font-medium text-gray-700 bg-white hover:bg-gray-50 transition-all border-b-4 border-blue-600" data-target="login">Login</button>
            <button id="signup-tab" class="tab-button w-1/2 py-3 text-center text-lg font-medium text-gray-700 bg-white hover:bg-gray-50 transition-all border-b-4 border-transparent" data-target="signup">Signup</button>
        </div>

        <!-- Content -->
        <div class="p-6">
            <div id="login" class="tab-content">
                <!-- Login Form -->
                <form id="loginForm" name="login_unitax" autocomplete="off" class="space-y-4">
                    <div class="space-y-1">
                        <label for="loginEmail" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="loginEmail" name="email" placeholder="Enter your email" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                    </div>
                    <div class="space-y-1">
                        <label for="loginPassword" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="loginPassword" name="password" placeholder="Enter your password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                    </div>
                    <button type="submit" id="loginsubmit" class="btn-primary w-full p-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-all shadow-md">
                        Login
                    </button>
                    <p class="text-center text-sm mt-2">Don't have an account? 
                        <a href="#" onclick="switchTab('signup')" class="text-blue-600 font-medium hover:text-blue-700">Signup here</a>
                    </p>
                </form>
            </div>

            <div id="signup" class="tab-content hidden">
                <!-- Signup Form -->
                <form id="signupForm" name="signup_unitax" autocomplete="on" class="space-y-4">
                    <div class="space-y-1">
                        <label for="signupName" class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" id="signupName" name="name" placeholder="Enter your full name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                    </div>
                    <div class="space-y-1">
                        <label for="signupEmail" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="signupEmail" name="email" placeholder="Enter your email" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                        <p id="emailError" class="text-xs text-red-500 hidden pt-1">This email is already registered.</p>
                    </div>
                    <div class="space-y-1">
                        <label for="signupPassword" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="signupPassword" name="password" placeholder="Create a password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                    </div>
                    <div class="space-y-1">
                        <label for="signupConfirmPassword" class="block text-sm font-medium text-gray-700">Confirm Password</label>
                        <input type="password" id="signupConfirmPassword" name="confirm_password" placeholder="Confirm your password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                        <p id="passwordError" class="text-xs text-red-500 hidden pt-1">Passwords do not match.</p>
                    </div>
                    <button type="submit" id="signup_btn" class="btn-primary w-full p-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-all shadow-md">
                        Signup
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Custom Message Box (Replaces alert/confirm) -->
    <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
            <h3 id="messageTitle" class="text-xl font-bold mb-3 text-gray-800"></h3>
            <p id="messageText" class="text-gray-600 mb-4"></p>
            <button onclick="document.getElementById('messageBox').classList.add('hidden')" class="w-full p-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">OK</button>
        </div>
    </div>

    <script>
        // ðŸš€ CRITICAL: Update this URL with your deployed Apps Script Web App URL
        const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzpPlNeJL9yaiMVVeg3V38SgJLSBmITT6RYLM4_xnvZJA-FZKpXjKtDjBibv9ngtmTs/exec'; 
        
        // --- UI UTILITIES ---

        /** Shows a custom modal message box instead of using alert() */
        function showMessageBox(title, message) {
            document.getElementById('messageTitle').textContent = title;
            document.getElementById('messageText').textContent = message;
            document.getElementById('messageBox').classList.remove('hidden');
            document.getElementById('messageBox').classList.add('flex');
        }

        /** Switches the active tab content */
        function switchTab(targetId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(targetId).classList.remove('hidden');
            
            document.querySelectorAll('.tab-button').forEach(b => {
                b.classList.remove('border-blue-600');
                b.classList.add('border-transparent');
            });

            document.getElementById(`${targetId}-tab`).classList.remove('border-transparent');
            document.getElementById(`${targetId}-tab`).classList.add('border-blue-600');
            
            // Clear errors on tab switch
            document.getElementById('passwordError').classList.add('hidden');
            document.getElementById('emailError').classList.add('hidden');
        }

        // Initialize tabs to login view
        document.addEventListener('DOMContentLoaded', () => {
            switchTab('login');
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => switchTab(e.target.dataset.target));
            });
            document.getElementById('signupEmail').addEventListener('input', checkingDuplicacy);
        });

        // --- CORE API HANDLERS (using fetch) ---

        /**
         * Core function to handle POST requests (Save/Update/Delete).
         */
        async function apiPost(action, payload = {}, sheetName = 'signup') {
            const button = document.getElementById(action === 'saveData' ? 'signup_btn' : 'loginsubmit');
            if (button) {
                button.innerHTML = 'Processing...';
                button.disabled = true;
            }

            const uniqueCode = crypto.randomUUID();
            const formData = new FormData();
            
            // Add control parameters
            formData.append('action', action);
            formData.append('sheet_name', sheetName);
            formData.append('uniqueCode', uniqueCode);
            
            // Add payload data
            for (const key in payload) {
                formData.append(key, payload[key]);
            }

            try {
                const response = await fetch(APP_SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (button) {
                    button.innerHTML = action === 'saveData' ? 'Signup' : 'Login';
                    button.disabled = false;
                }
                
                return result;

            } catch (error) {
                if (button) {
                    button.innerHTML = action === 'saveData' ? 'Signup' : 'Login';
                    button.disabled = false;
                }
                showMessageBox('Network Error', 'Failed to connect to the Apps Script server. Check the URL and deployment.');
                return { status: "ERROR", message: error.message };
            }
        }

        /**
         * Core function to handle GET requests (Read/Query).
         */
        async function apiGet(action, params = {}, sheetName = 'signup') {
            const uniqueCode = crypto.randomUUID();
            
            const searchParams = new URLSearchParams({
                action,
                sheet_name: sheetName,
                uniqueCode,
                ...params
            });
            
            const fullUrl = `${APP_SCRIPT_URL}?${searchParams.toString()}`;

            try {
                const response = await fetch(fullUrl);
                const result = await response.json();
                return result;
            } catch (error) {
                showMessageBox('Network Error', 'Failed to connect to the Apps Script server. Check the URL and deployment.');
                return { status: "ERROR", message: error.message };
            }
        }

        // --- AUTHENTICATION LOGIC ---

        // 1. SIGNUP LOGIC
        document.getElementById('signupForm').addEventListener('submit', async function(event) {
            event.preventDefault(); 
            
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const errorDiv = document.getElementById('passwordError');

            if (password !== confirmPassword) {
                errorDiv.classList.remove('hidden');
                return;
            } else {
                errorDiv.classList.add('hidden');
            }

            const form = event.target;
            const formData = new FormData(form);
            const payload = Object.fromEntries(formData);
            
            // Add required status field
            payload.idstatus = "active";
            
            // Remove confirm password before sending to server
            delete payload.confirm_password; 

            // Check for duplication one last time before submitting
            const emailCheckResponse = await apiGet('getRowData', { column_to_search: 'email', document_number: payload.email }, 'signup');
            if (emailCheckResponse.status === "SUCCESS" && emailCheckResponse.matching_rows.length > 0) {
                 showMessageBox('Signup Failed', 'This email is already registered. Please log in or use a different email.');
                 return;
            }

            const result = await apiPost('saveData', payload, 'signup');

            if (result.status === "SUCCESS") {
                showMessageBox('Signup Successful!', `Welcome ${payload.name}. Your document number is: ${result.documentNumber}.`);
                form.reset();
                switchTab('login');
            } else {
                showMessageBox('Signup Failed', result.message || 'An unknown error occurred during signup.');
            }
        });

        // 2. LOGIN LOGIC
        document.getElementById('loginForm').addEventListener('submit', async function (event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const loginButton = document.getElementById('loginsubmit');

            loginButton.innerHTML = "Checking...";
            loginButton.disabled = true;

            try {
                // Step 1: Check for Email existence
                const emailCheckResponse = await apiGet('getRowData', { 
                    column_to_search: 'email', 
                    document_number: email 
                }, 'signup');

                if (emailCheckResponse.status !== "SUCCESS" || emailCheckResponse.matching_rows.length === 0) {
                    showMessageBox('Login Failed', 'User not found. Check your email or sign up.');
                    return;
                }

                const userData = emailCheckResponse.matching_rows[0];

                // Step 2: Validate Password and Status
                if (userData.password.trim() === password && userData.idstatus === "active") {
                    
                    // --- Session Management (Using localStorage for this demo) ---
                    console.log("Login Success. Saving session data.");
                    localStorage.setItem('userloginid', userData['Document Number']);
                    localStorage.setItem('userName', userData.name);
                    localStorage.setItem('useremail_we', userData.email);
                    // -------------------------------------------------------------
                    
                    showMessageBox('Login Successful', `Welcome back, ${userData.name}! Redirecting...`);
                    // Simulate redirection to a dashboard or index page
                    // In a real scenario, this would go to your protected app page.
                    setTimeout(() => {
                        window.location.href = './index.html' || '/'; // Use a relative path
                    }, 1500);
                    
                } else {
                    showMessageBox('Access Denied', 'Invalid password or account is not active.');
                }
            } catch (error) {
                showMessageBox('Critical Error', 'An unexpected error occurred during the login process.');
                console.error(error);
            } finally {
                loginButton.innerHTML = "Login";
                loginButton.disabled = false;
            }
        });

        // 3. EMAIL DUPLICACY CHECK (Debounced)
        let debounceTimer; 

        function checkingDuplicacy() {
            const emailInput = document.getElementById('signupEmail');
            const email = emailInput.value.trim();
            const errorDiv = document.getElementById('emailError');

            if (!email) {
                clearTimeout(debounceTimer);
                errorDiv.classList.add('hidden');
                emailInput.classList.remove('border-red-500');
                return;
            }

            clearTimeout(debounceTimer);

            debounceTimer = setTimeout(async () => {
                const response = await apiGet('getRowData', { 
                    column_to_search: 'email', 
                    document_number: email 
                }, 'signup');

                if (response.status === "SUCCESS" && response.matching_rows.length > 0) {
                    errorDiv.classList.remove('hidden');
                    emailInput.classList.add('border-red-500');
                    document.getElementById('signup_btn').disabled = true;
                } else {
                    errorDiv.classList.add('hidden');
                    emailInput.classList.remove('border-red-500');
                    document.getElementById('signup_btn').disabled = false;
                }
            }, 700); // 700ms debounce
        }
    </script>
</body>
</html>
